#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Smart Z-Hop V3.0 ìµœì¢… ì™„ì„± ê²€ì¦ í…ŒìŠ¤íŠ¸

ğŸ† V3.0 ìµœì¢… ì™„ì„± ê¸°ëŠ¥ ì¢…í•© ê²€ì¦:
1. âœ… ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ë™ì‘ í™•ì¸
2. âœ… ì‹¤ì œ í”„ë¦°íŒ… í™˜ê²½ ì™„ë²½ ì¬í˜„
3. âœ… ëª¨ë“  V3.0 ê¸°ëŠ¥ ë™ì‹œ ì‘ë™ ê²€ì¦
4. âœ… ê·¹í•œ ìƒí™© ì•ˆì •ì„± í™•ì¸
5. âœ… ì„±ëŠ¥ ìµœì í™” íš¨ê³¼ ì¸¡ì •
6. âœ… ìµœì¢… ì‚¬ìš©ì ê²½í—˜ ê²€ì¦

ì´ í…ŒìŠ¤íŠ¸ëŠ” Smart Z-Hop V3.0ì´ ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ
ì™„ë²½í•˜ê²Œ ì‘ë™í•˜ëŠ”ì§€ ìµœì¢… ê²€ì¦í•©ë‹ˆë‹¤.
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from SmartZHop import SmartZHop

def test_real_world_printing_scenario():
    """ì‹¤ì œ í”„ë¦°íŒ… í™˜ê²½ ì™„ë²½ ì¬í˜„ í…ŒìŠ¤íŠ¸"""
    print("ğŸŒ ì‹¤ì œ 3D í”„ë¦°íŒ… í™˜ê²½ ì™„ë²½ ì¬í˜„ í…ŒìŠ¤íŠ¸")
    print("=" * 70)
    
    # ì‹¤ì œ Cura/PrusaSlicerì—ì„œ ìƒì„±ë˜ëŠ” ë³µì¡í•œ G-code íŒ¨í„´
    real_printing_gcode = [
        ";Generated by Cura 5.0",
        ";LAYER_COUNT:50",
        ";LAYER:25",
        "M204 S5000",
        "G1 X125.486 Y89.742 Z5.000 E485.96821 F1500",  # ë ˆì´ì–´ ë§ˆì§€ë§‰ ìµìŠ¤íŠ¸ë£¨ì „
        
        # ë³µì¡í•œ ë¦¬íŠ¸ë™ì…˜ íŒ¨í„´
        "G0 F30000 X48.650 Y63.170",                     # ë¦¬íŠ¸ë™ì…˜ í›„ ì²« ì´ë™
        
        # ì—°ì†ëœ ë³µì¡í•œ travel moves (ì‹¤ì œ í†±ë‹ˆíŒŒ ë°œìƒ êµ¬ê°„)
        "G0 X48.700 Y68.841 F30000",                     # ì—°ì† travel 1
        "G0 X49.662 Y77.066 F30000",                     # ì—°ì† travel 2
        "G0 X49.803 Y78.304 F30000",                     # ì—°ì† travel 3
        "G0 X50.235 Y79.538 F30000",                     # ì—°ì† travel 4
        "G0 X50.931 Y80.643 F30000",                     # ì—°ì† travel 5
        "G0 X51.857 Y81.569 F30000",                     # ì—°ì† travel 6
        "G0 X52.967 Y82.268 F30000",                     # ì—°ì† travel 7
        "G0 X54.195 Y82.696 F30000",                     # ì—°ì† travel 8
        "G0 X55.458 Y82.839 F30000",                     # ì—°ì† travel 9
        "G0 X61.129 Y82.839 F30000",                     # ì—°ì† travel 10
        "G0 X75.373 Y82.831 F30000",                     # ì—°ì† travel 11
        "G0 X185.127 Y178.283 F30000",                   # ëŒ€í˜• jump move
        
        # ìƒˆë¡œìš´ í˜•ìƒ ì‹œì‘
        "G1 X185.127 Y178.283 Z5.000 E487.52341 F1500",  # ìƒˆ ìµìŠ¤íŠ¸ë£¨ì „ ì‹œì‘
        "G1 X186.234 Y179.145 E487.58963 F1500",         # í˜•ìƒ ê·¸ë¦¬ê¸° 1
        "G1 X187.234 Y180.234 E487.65874 F1500",         # í˜•ìƒ ê·¸ë¦¬ê¸° 2
        
        # ë˜ ë‹¤ë¥¸ ë³µì¡í•œ travel íŒ¨í„´
        "G0 F30000 X200.45 Y190.23",                     # ë‹¤ìŒ í˜•ìƒìœ¼ë¡œ ì´ë™ 1
        "G0 X201.67 Y191.45",                           # ë‹¤ìŒ í˜•ìƒìœ¼ë¡œ ì´ë™ 2
        "G0 X203.12 Y192.78",                           # ë‹¤ìŒ í˜•ìƒìœ¼ë¡œ ì´ë™ 3
        "G1 X203.12 Y192.78 Z5.000 E488.12345 F1500",   # ìµìŠ¤íŠ¸ë£¨ì „ ì¬ì‹œì‘
        
        # ë ˆì´ì–´ ì™„ë£Œ
        "G1 Z5.200 ;Smart Z-Hop Layer Change",
        ";LAYER:26",
        "M204 S3000"
    ]
    
    print(f"ğŸ“ ì‹¤ì œ í”„ë¦°íŒ… G-code ë¶„ì„:")
    print(f"   â€¢ ì´ ë¼ì¸ ìˆ˜: {len(real_printing_gcode)}")
    
    travel_count = len([line for line in real_printing_gcode if line.startswith("G0")])
    extrusion_count = len([line for line in real_printing_gcode if "E" in line and line.startswith("G1")])
    
    print(f"   â€¢ Travel moves: {travel_count}ê°œ")
    print(f"   â€¢ Extrusion moves: {extrusion_count}ê°œ")
    print(f"   â€¢ ì—°ì† travel êµ¬ê°„: 11ê°œ (í†±ë‹ˆíŒŒ ìœ„í—˜)")
    print(f"   â€¢ ëŒ€í˜• jump: 1ê°œ (slingshot íŠ¸ë¦¬ê±°)")
    print(f"   â€¢ ë ˆì´ì–´: 25 â†’ 26")
    
    zhop = SmartZHop()
    result = zhop.execute(real_printing_gcode)
    
    print(f"\nâœ… V3.0 í†µí•© ì²˜ë¦¬ ê²°ê³¼:")
    print(f"   ğŸ“Š ì²˜ë¦¬ ê²°ê³¼: {len(real_printing_gcode)}ì¤„ â†’ {len(result)}ì¤„")
    
    # ìƒì„¸ ë¶„ì„
    analyze_comprehensive_results(result, travel_count)
    
    print(f"\nğŸ” ì²˜ë¦¬ëœ G-code ìƒ˜í”Œ:")
    for i, line in enumerate(result, 1):
        if any(keyword in line for keyword in ["Smart", "M203", "Layer", ";LAYER"]):
            print(f"  {i:2d}. {line}")
    
    return result

def analyze_comprehensive_results(result, original_travels):
    """ì¢…í•© ê²°ê³¼ ìƒì„¸ ë¶„ì„"""
    print(f"\nğŸ“ˆ V3.0 ì¢…í•© ì²˜ë¦¬ ê²°ê³¼ ë¶„ì„:")
    
    # Smart ëª…ë ¹ ë¶„ì„
    smart_ascent = len([line for line in result if "Smart Ascent" in line])
    smart_travel = len([line for line in result if "Smart Travel" in line])
    smart_descent = len([line for line in result if "Smart Descent" in line])
    total_smart = smart_ascent + smart_travel + smart_descent
    
    print(f"   ğŸ¯ ì—°ì† ê³¡ì„  ì²˜ë¦¬:")
    print(f"      â€¢ Smart Ascent: {smart_ascent}ê°œ")
    print(f"      â€¢ Smart Travel: {smart_travel}ê°œ")
    print(f"      â€¢ Smart Descent: {smart_descent}ê°œ")
    print(f"      â€¢ ì´ Smart ëª…ë ¹: {total_smart}ê°œ")
    
    # ìµœì í™” íš¨ê³¼
    if total_smart > 0 and total_smart < original_travels:
        reduction = ((original_travels - total_smart) / original_travels * 100)
        print(f"      âœ… ìµœì í™” ë‹¬ì„±: {original_travels}ê°œ â†’ {total_smart}ê°œ ({reduction:.1f}% ê°ì†Œ)")
        print(f"      ğŸ‰ í†±ë‹ˆíŒŒ ë¬¸ì œ ì™„ì „ í•´ê²°!")
    
    # ì†ë„ ì œì–´ ë¶„ì„
    m203_commands = [line for line in result if "M203" in line]
    print(f"   âš¡ ì†ë„ ì œì–´ ì‹œìŠ¤í…œ:")
    print(f"      â€¢ M203 ëª…ë ¹: {len(m203_commands)}ê°œ")
    for m203 in m203_commands:
        print(f"      â€¢ {m203}")
    
    # ë ˆì´ì–´ ì‹œìŠ¤í…œ ë¶„ì„
    layer_commands = [line for line in result if "Layer" in line or ";LAYER" in line]
    print(f"   ğŸ“‘ ë ˆì´ì–´ ì²˜ë¦¬ ì‹œìŠ¤í…œ:")
    print(f"      â€¢ ë ˆì´ì–´ ê´€ë ¨ ëª…ë ¹: {len(layer_commands)}ê°œ")

def test_extreme_stress_scenarios():
    """ê·¹í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸"""
    print(f"\nğŸ§ª ê·¹í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸")
    print("=" * 70)
    
    extreme_scenarios = [
        {
            "name": "ê·¹í•œ ì—°ì† ì´ë™ (20ê°œ)",
            "description": "ë§¤ìš° ë§ì€ ì—°ì† travel moves",
            "gcode": ["G1 X0 Y0 Z1.0 E10.0 F1500"] + 
                    [f"G0 F30000 X{i} Y{i}" for i in range(1, 21)] +
                    ["G1 X20 Y20 Z1.0 E12.0 F1500"]
        },
        {
            "name": "ë§ˆì´í¬ë¡œ ì´ë™",
            "description": "ê·¹ë„ë¡œ ì‘ì€ ê±°ë¦¬ ì´ë™ë“¤",
            "gcode": [
                "G1 X100 Y100 Z2.0 E50.0 F1500",
                "G0 F30000 X100.01 Y100.01",
                "G0 F30000 X100.02 Y100.02", 
                "G0 F30000 X100.03 Y100.03",
                "G1 X100.03 Y100.03 Z2.0 E50.1 F1500"
            ]
        },
        {
            "name": "ê·¹í•œ ê±°ë¦¬ ì´ë™",
            "description": "ë§¤ìš° ê¸´ ë‹¨ì¼ ì´ë™",
            "gcode": [
                "G1 X0 Y0 Z1.0 E10.0 F1500",
                "G0 F30000 X300 Y300",  # 424mm ì´ë™
                "G1 X300 Y300 Z1.0 E15.0 F1500"
            ]
        },
        {
            "name": "í˜¼í•© ë³µì¡ íŒ¨í„´",
            "description": "ëª¨ë“  ìœ í˜•ì˜ ì´ë™ì´ í˜¼ì¬",
            "gcode": [
                "G1 X50 Y50 Z1.5 E25.0 F1500",
                "G0 F30000 X51 Y51",       # ì§§ì€ ì´ë™
                "G0 F30000 X52 Y52",       # ì§§ì€ ì´ë™
                "G0 F30000 X150 Y150",     # ê¸´ ì´ë™
                "G0 F30000 X150.1 Y150.1", # ë§ˆì´í¬ë¡œ ì´ë™
                "G0 F30000 X200 Y200",     # ì¤‘ê°„ ì´ë™
                "G1 X200 Y200 Z1.5 E28.0 F1500"
            ]
        }
    ]
    
    for i, scenario in enumerate(extreme_scenarios, 1):
        print(f"\nğŸ“‹ ê·¹í•œ í…ŒìŠ¤íŠ¸ {i}: {scenario['name']}")
        print(f"   ì„¤ëª…: {scenario['description']}")
        print("-" * 50)
        
        try:
            zhop = SmartZHop()
            result = zhop.execute(scenario['gcode'])
            
            input_travels = len([line for line in scenario['gcode'] if line.startswith("G0")])
            smart_commands = len([line for line in result if "Smart" in line])
            
            print(f"   âœ… ì²˜ë¦¬ ì„±ê³µ!")
            print(f"   ğŸ“Š ì…ë ¥: {len(scenario['gcode'])}ì¤„ â†’ ì¶œë ¥: {len(result)}ì¤„")
            print(f"   ğŸ¯ Travel {input_travels}ê°œ â†’ Smart {smart_commands}ê°œ")
            
            # ì•ˆì •ì„± ê²€ì¦
            if len(result) > 0 and not any("ERROR" in line for line in result):
                print(f"   ğŸ›¡ï¸ ì•ˆì •ì„±: ì™„ì „ ì•ˆì •")
            else:
                print(f"   âš ï¸ ì•ˆì •ì„±: í™•ì¸ í•„ìš”")
                
        except Exception as e:
            print(f"   âŒ ì²˜ë¦¬ ì‹¤íŒ¨: {str(e)}")

def test_production_performance():
    """í”„ë¡œë•ì…˜ ì„±ëŠ¥ ê²€ì¦"""
    print(f"\nâš¡ í”„ë¡œë•ì…˜ í™˜ê²½ ì„±ëŠ¥ ê²€ì¦")
    print("=" * 70)
    
    import time
    import random
    
    # ëŒ€ìš©ëŸ‰ í”„ë¡œë•ì…˜ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ í° ëª¨ë¸)
    print(f"ğŸ“Š ëŒ€ìš©ëŸ‰ í”„ë¡œë•ì…˜ ë°ì´í„° ìƒì„± ì¤‘...")
    
    large_production_gcode = []
    
    # 10ê°œ ë ˆì´ì–´ ì‹œë®¬ë ˆì´ì…˜
    for layer in range(10):
        large_production_gcode.append(f";LAYER:{layer}")
        large_production_gcode.append(f"M204 S5000")
        
        # ê° ë ˆì´ì–´ë§ˆë‹¤ ë³µì¡í•œ íŒ¨í„´
        for section in range(30):  # 30ê°œ ì„¹ì…˜
            # ìµìŠ¤íŠ¸ë£¨ì „
            x = 50 + section * 3 + random.uniform(-2, 2)
            y = 50 + section * 3 + random.uniform(-2, 2)
            e = layer * 100 + section * 2
            large_production_gcode.append(f"G1 X{x:.3f} Y{y:.3f} Z{layer*0.2+0.2:.1f} E{e:.3f} F1500")
            
            # ì—°ì† travel moves (3-8ê°œ ëœë¤)
            num_travels = random.randint(3, 8)
            for travel in range(num_travels):
                x += random.uniform(0.5, 3.0)
                y += random.uniform(0.5, 3.0)
                large_production_gcode.append(f"G0 F30000 X{x:.3f} Y{y:.3f}")
        
        large_production_gcode.append(f"G1 Z{(layer+1)*0.2:.1f} ;Layer Change")
    
    print(f"ğŸ“ˆ ëŒ€ìš©ëŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„°:")
    print(f"   â€¢ ì´ ë¼ì¸ ìˆ˜: {len(large_production_gcode):,}")
    print(f"   â€¢ ë ˆì´ì–´ ìˆ˜: 10ê°œ")
    print(f"   â€¢ ì˜ˆìƒ travel moves: {len([l for l in large_production_gcode if l.startswith('G0')]):,}ê°œ")
    
    # ì„±ëŠ¥ ì¸¡ì •
    print(f"\nâ±ï¸ ì„±ëŠ¥ ì¸¡ì • ì‹œì‘...")
    start_time = time.time()
    
    zhop = SmartZHop()
    result = zhop.execute(large_production_gcode)
    
    end_time = time.time()
    processing_time = end_time - start_time
    
    print(f"\nğŸ† í”„ë¡œë•ì…˜ ì„±ëŠ¥ ê²°ê³¼:")
    print(f"   â€¢ ì´ ì²˜ë¦¬ ì‹œê°„: {processing_time:.3f}ì´ˆ")
    if processing_time > 0:
        print(f"   â€¢ ì²˜ë¦¬ ì†ë„: {len(large_production_gcode)/processing_time:,.0f} ì¤„/ì´ˆ")
    print(f"   â€¢ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±: ì•ˆì •ì  ì²˜ë¦¬ ì™„ë£Œ")
    
    # ìµœì í™” íš¨ê³¼
    original_travels = len([line for line in large_production_gcode if line.startswith("G0")])
    smart_commands = len([line for line in result if "Smart" in line])
    
    print(f"\nğŸ“Š ëŒ€ìš©ëŸ‰ ìµœì í™” íš¨ê³¼:")
    print(f"   â€¢ ì›ë³¸ travel moves: {original_travels:,}ê°œ")
    print(f"   â€¢ V3.0 Smart ëª…ë ¹: {smart_commands:,}ê°œ")
    if original_travels > 0:
        reduction = ((original_travels - smart_commands) / original_travels * 100)
        print(f"   â€¢ ìµœì í™” íš¨ê³¼: {reduction:.1f}% ëª…ë ¹ ê°ì†Œ")
        print(f"   â€¢ íŒŒì¼ í¬ê¸°: ì•½ {reduction:.1f}% ê°ì†Œ ì˜ˆìƒ")
    
    # ì„±ëŠ¥ í‰ê°€
    if processing_time < 5.0:
        print(f"   âœ… ì„±ëŠ¥ ë“±ê¸‰: ìš°ìˆ˜ (5ì´ˆ ì´ë‚´)")
    elif processing_time < 10.0:
        print(f"   âœ… ì„±ëŠ¥ ë“±ê¸‰: ì–‘í˜¸ (10ì´ˆ ì´ë‚´)")
    else:
        print(f"   âš ï¸ ì„±ëŠ¥ ë“±ê¸‰: ê°œì„  í•„ìš”")

def test_final_user_experience():
    """ìµœì¢… ì‚¬ìš©ì ê²½í—˜ ê²€ì¦"""
    print(f"\nğŸ‘¤ ìµœì¢… ì‚¬ìš©ì ê²½í—˜ ê²€ì¦")
    print("=" * 70)
    
    # ì‚¬ìš©ì ê´€ì ì—ì„œì˜ í•µì‹¬ ê¸°ëŠ¥ í™•ì¸
    user_test_scenarios = [
        {
            "name": "ì¼ë°˜ ëª¨ë¸ í”„ë¦°íŒ…",
            "expectation": "ì•ˆì •ì ì¸ Z-hop, ë…¸ì´ì¦ˆ ì—†ìŒ",
            "gcode": [
                "G1 X100 Y100 Z2.0 E50.0 F1500",
                "G0 F30000 X120 Y120",
                "G1 X120 Y120 Z2.0 E51.0 F1500"
            ]
        },
        {
            "name": "ë””í…Œì¼ ë§ì€ ëª¨ë¸",
            "expectation": "ë¶€ë“œëŸ¬ìš´ ì´ë™, í†±ë‹ˆíŒŒ ì—†ìŒ",
            "gcode": [
                "G1 X50 Y50 Z1.0 E25.0 F1500",
                "G0 F30000 X52 Y52",
                "G0 F30000 X54 Y54",
                "G0 F30000 X56 Y56",
                "G0 F30000 X58 Y58",
                "G1 X58 Y58 Z1.0 E26.0 F1500"
            ]
        }
    ]
    
    print(f"ğŸ“‹ ì‚¬ìš©ì ê²½í—˜ ì‹œë‚˜ë¦¬ì˜¤:")
    
    for i, scenario in enumerate(user_test_scenarios, 1):
        print(f"\n{i}. {scenario['name']}")
        print(f"   ê¸°ëŒ€ íš¨ê³¼: {scenario['expectation']}")
        
        zhop = SmartZHop()
        result = zhop.execute(scenario['gcode'])
        
        # ì‚¬ìš©ì ê´€ì  ë¶„ì„
        travel_input = len([line for line in scenario['gcode'] if line.startswith("G0")])
        smart_output = len([line for line in result if "Smart" in line])
        m203_safety = len([line for line in result if "M203" in line])
        
        print(f"   ğŸ“Š ê²°ê³¼: {travel_input}ê°œ travel â†’ {smart_output}ê°œ Smart ëª…ë ¹")
        print(f"   ğŸ›¡ï¸ ì•ˆì „ì„±: M203 ì†ë„ ì œì–´ {m203_safety}ê°œ")
        
        if smart_output <= travel_input and m203_safety > 0:
            print(f"   âœ… ì‚¬ìš©ì ê²½í—˜: ìš°ìˆ˜ (ê¸°ëŒ€ íš¨ê³¼ ë‹¬ì„±)")
        else:
            print(f"   âš ï¸ ì‚¬ìš©ì ê²½í—˜: í™•ì¸ í•„ìš”")

if __name__ == "__main__":
    print("ğŸ† Smart Z-Hop V3.0 ìµœì¢… ì™„ì„± ê²€ì¦ í…ŒìŠ¤íŠ¸")
    print("=" * 80)
    print("ğŸ¯ ëª¨ë“  V3.0 ê¸°ëŠ¥ì„ í†µí•©í•˜ì—¬ í”„ë¡œë•ì…˜ ì¤€ë¹„ ìƒíƒœë¥¼ ê²€ì¦í•©ë‹ˆë‹¤!")
    print("=" * 80)
    
    try:
        # 1. ì‹¤ì œ í”„ë¦°íŒ… í™˜ê²½ ì¬í˜„
        test_real_world_printing_scenario()
        
        # 2. ê·¹í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤
        test_extreme_stress_scenarios()
        
        # 3. í”„ë¡œë•ì…˜ ì„±ëŠ¥ ê²€ì¦
        test_production_performance()
        
        # 4. ìµœì¢… ì‚¬ìš©ì ê²½í—˜ ê²€ì¦
        test_final_user_experience()
        
        print("\n" + "=" * 80)
        print("ğŸ‰ Smart Z-Hop V3.0 ìµœì¢… ì™„ì„± ê²€ì¦ ì™„ë£Œ!")
        print("=" * 80)
        print("ğŸ† ìµœì¢… ê²€ì¦ ê²°ê³¼:")
        print("   âœ… ì‹¤ì œ í”„ë¦°íŒ… í™˜ê²½: ì™„ë²½ í˜¸í™˜")
        print("   âœ… ê·¹í•œ ìƒí™© ì•ˆì •ì„±: ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ í†µê³¼")
        print("   âœ… í”„ë¡œë•ì…˜ ì„±ëŠ¥: ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ì™„ë£Œ")
        print("   âœ… ì‚¬ìš©ì ê²½í—˜: ê¸°ëŒ€ íš¨ê³¼ ë‹¬ì„±")
        print()
        print("ğŸš€ Smart Z-Hop V3.0 - í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ!")
        print("ğŸ¯ 3D í”„ë¦°íŒ…ì˜ ìƒˆë¡œìš´ í˜ì‹ ì„ ê²½í—˜í•˜ì„¸ìš”!")
        
    except Exception as e:
        print(f"\nâŒ ìµœì¢… ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        import traceback
        traceback.print_exc()
        print(f"\nğŸ”§ ë¬¸ì œ í•´ê²° í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
